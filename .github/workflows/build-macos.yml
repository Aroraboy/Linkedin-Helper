name: Build Desktop App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            arch: x64
            platform: mac
          - os: macos-latest
            arch: arm64
            platform: mac
          - os: windows-latest
            arch: x64
            platform: win

    runs-on: ${{ matrix.os }}
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ─── Python deps ──────────────────────────────────────────────────
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install Playwright Chromium
        run: python -m playwright install chromium

      - name: Install Playwright system deps (macOS)
        if: matrix.platform == 'mac'
        run: python -m playwright install-deps chromium

      # ─── Find Playwright browsers (macOS) ─────────────────────────────
      - name: Find Playwright browsers (macOS)
        if: matrix.platform == 'mac'
        id: pw_mac
        run: |
          PW_PATH=$(python -c "
          import os
          pw_dir = os.path.dirname(__import__('playwright').__file__)
          local = os.path.join(pw_dir, 'driver', 'package', '.local-browsers')
          cache = os.path.join(os.path.expanduser('~'), 'Library', 'Caches', 'ms-playwright')
          print(local if os.path.isdir(local) else (cache if os.path.isdir(cache) else ''))
          ")
          echo "path=$PW_PATH" >> $GITHUB_OUTPUT
          echo "Playwright browsers: $PW_PATH"

      # ─── Find Playwright browsers (Windows) ───────────────────────────
      - name: Find Playwright browsers (Windows)
        if: matrix.platform == 'win'
        id: pw_win
        shell: pwsh
        run: |
          $pw_dir = python -c "import os; print(os.path.dirname(__import__('playwright').__file__))"
          $local = Join-Path $pw_dir "driver\package\.local-browsers"
          $cache = Join-Path $env:LOCALAPPDATA "ms-playwright"
          if (Test-Path $local) { $result = $local }
          elseif (Test-Path $cache) { $result = $cache }
          else { $result = "" }
          echo "path=$result" >> $env:GITHUB_OUTPUT
          Write-Host "Playwright browsers: $result"

      # ─── PyInstaller (macOS) ───────────────────────────────────────────
      - name: Bundle Python backend (macOS)
        if: matrix.platform == 'mac'
        run: |
          pyinstaller \
            --name linkedin_helper \
            --distpath electron/python_dist \
            --workpath build/pyinstaller \
            --noconfirm --log-level WARN \
            --add-data "web/templates:web/templates" \
            --add-data "web/static:web/static" \
            --add-data "templates:templates" \
            --add-data "config.py:." \
            --add-data "app.py:." \
            --add-data "db.py:." \
            --add-data "logger.py:." \
            --add-data "linkedin_bot.py:." \
            --add-data "spreadsheet_reader.py:." \
            --add-data "web/__init__.py:web" \
            --add-data "web/models.py:web" \
            --add-data "web/auth.py:web" \
            --add-data "web/dashboard.py:web" \
            --add-data "web/forms.py:web" \
            --add-data "web/worker.py:web" \
            --add-data "web/linkedin_auth.py:web" \
            --add-data "web/interactive_login.py:web" \
            --add-data "requirements.txt:." \
            --hidden-import flask --hidden-import flask_login \
            --hidden-import flask_sqlalchemy --hidden-import flask_wtf \
            --hidden-import wtforms --hidden-import email_validator \
            --hidden-import sqlalchemy --hidden-import "sqlalchemy.dialects.sqlite" \
            --hidden-import playwright --hidden-import playwright.sync_api \
            --hidden-import openpyxl --hidden-import gspread \
            --hidden-import google.auth --hidden-import rich \
            --hidden-import dotenv --hidden-import jinja2 \
            --hidden-import markupsafe --hidden-import werkzeug \
            --hidden-import click --hidden-import itsdangerous \
            --hidden-import blinker --hidden-import greenlet \
            --hidden-import app --hidden-import config \
            --hidden-import db --hidden-import logger \
            --hidden-import linkedin_bot --hidden-import spreadsheet_reader \
            --hidden-import web --hidden-import web.models \
            --hidden-import web.auth --hidden-import web.dashboard \
            --hidden-import web.forms --hidden-import web.worker \
            --hidden-import web.linkedin_auth --hidden-import web.interactive_login \
            --collect-all playwright \
            electron/pyinstaller_entry.py

      # ─── PyInstaller (Windows) ─────────────────────────────────────────
      - name: Bundle Python backend (Windows)
        if: matrix.platform == 'win'
        shell: pwsh
        run: |
          pyinstaller `
            --name linkedin_helper `
            --distpath electron/python_dist `
            --workpath build/pyinstaller `
            --noconfirm --log-level WARN `
            --add-data "web/templates;web/templates" `
            --add-data "web/static;web/static" `
            --add-data "templates;templates" `
            --add-data "config.py;." `
            --add-data "app.py;." `
            --add-data "db.py;." `
            --add-data "logger.py;." `
            --add-data "linkedin_bot.py;." `
            --add-data "spreadsheet_reader.py;." `
            --add-data "web/__init__.py;web" `
            --add-data "web/models.py;web" `
            --add-data "web/auth.py;web" `
            --add-data "web/dashboard.py;web" `
            --add-data "web/forms.py;web" `
            --add-data "web/worker.py;web" `
            --add-data "web/linkedin_auth.py;web" `
            --add-data "web/interactive_login.py;web" `
            --add-data "requirements.txt;." `
            --hidden-import flask --hidden-import flask_login `
            --hidden-import flask_sqlalchemy --hidden-import flask_wtf `
            --hidden-import wtforms --hidden-import email_validator `
            --hidden-import sqlalchemy --hidden-import "sqlalchemy.dialects.sqlite" `
            --hidden-import playwright --hidden-import playwright.sync_api `
            --hidden-import openpyxl --hidden-import gspread `
            --hidden-import google.auth --hidden-import rich `
            --hidden-import dotenv --hidden-import jinja2 `
            --hidden-import markupsafe --hidden-import werkzeug `
            --hidden-import click --hidden-import itsdangerous `
            --hidden-import blinker --hidden-import greenlet `
            --hidden-import app --hidden-import config `
            --hidden-import db --hidden-import logger `
            --hidden-import linkedin_bot --hidden-import spreadsheet_reader `
            --hidden-import web --hidden-import web.models `
            --hidden-import web.auth --hidden-import web.dashboard `
            --hidden-import web.forms --hidden-import web.worker `
            --hidden-import web.linkedin_auth --hidden-import web.interactive_login `
            --collect-all playwright `
            electron/pyinstaller_entry.py

      # ─── Copy Playwright Chromium (macOS) ──────────────────────────────
      - name: Copy Playwright Chromium (macOS)
        if: matrix.platform == 'mac'
        run: |
          PW_BROWSERS="${{ steps.pw_mac.outputs.path }}"
          DEST="electron/python_dist/playwright_browsers"
          mkdir -p "$DEST"
          if [ -n "$PW_BROWSERS" ] && [ -d "$PW_BROWSERS" ]; then
            CHROMIUM_DIR=$(find "$PW_BROWSERS" -maxdepth 1 -type d -name "chromium-*" | head -1)
            if [ -n "$CHROMIUM_DIR" ]; then
              cp -R "$CHROMIUM_DIR" "$DEST/"
              echo "Copied Chromium. Size: $(du -sh "$DEST" | cut -f1)"
            fi
          fi

      # ─── Copy Playwright Chromium (Windows) ────────────────────────────
      - name: Copy Playwright Chromium (Windows)
        if: matrix.platform == 'win'
        shell: pwsh
        run: |
          $PW_BROWSERS = "${{ steps.pw_win.outputs.path }}"
          $DEST = "electron\python_dist\playwright_browsers"
          New-Item -ItemType Directory -Force -Path $DEST | Out-Null
          if ($PW_BROWSERS -and (Test-Path $PW_BROWSERS)) {
            $chromiumDir = Get-ChildItem -Path $PW_BROWSERS -Directory -Filter "chromium-*" | Select-Object -First 1
            if ($chromiumDir) {
              Copy-Item -Recurse -Force $chromiumDir.FullName -Destination "$DEST\"
              Write-Host "Copied Chromium from $($chromiumDir.FullName)"
            }
          }

      # ─── Verify ───────────────────────────────────────────────────────
      - name: Verify Python bundle
        shell: bash
        run: |
          echo "Bundle contents:"
          ls electron/python_dist/linkedin_helper/ 2>/dev/null | head -20 || dir electron\python_dist\linkedin_helper 2>nul | head -20
          echo "Playwright browsers:"
          ls electron/python_dist/playwright_browsers/ 2>/dev/null || dir electron\python_dist\playwright_browsers 2>nul || echo "(none)"

      # ─── Icon + Electron ───────────────────────────────────────────────
      - name: Generate app icon
        run: |
          pip install Pillow
          cd electron && python generate_icon.py || echo "Icon generation skipped"

      - name: Install Electron dependencies
        working-directory: electron
        run: npm install

      # ─── Build installer ───────────────────────────────────────────────
      - name: Build macOS installer
        if: matrix.platform == 'mac'
        working-directory: electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --mac --publish never

      - name: Build Windows installer
        if: matrix.platform == 'win'
        working-directory: electron
        run: npx electron-builder --win --publish never

      - name: List build output
        shell: bash
        run: ls -lh electron/dist/ 2>/dev/null || true

      # ─── Upload ────────────────────────────────────────────────────────
      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: LinkedIn-Helper-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            electron/dist/*.dmg
            electron/dist/*.zip
            electron/dist/*.exe
          retention-days: 90

      # ─── Release ───────────────────────────────────────────────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: LinkedIn Helper ${{ github.ref_name }}
          body: |
            ## LinkedIn Helper Desktop App

            ### macOS
            Download the `.dmg` for your Mac type:
            - **Apple Silicon** (M1/M2/M3/M4): `*-arm64.dmg`
            - **Intel**: `*-x64.dmg`

            Install: Double-click .dmg → drag to Applications → open
            (If blocked: Right-click → Open → Open)

            ### Windows
            Download the `.exe` installer and run it.

            ### First-time setup
            1. Register an account (local to your machine)
            2. Settings → Login in Browser → log into LinkedIn
            3. Upload CSV/XLSX with profile URLs
            4. Choose mode → Start!
          files: |
            electron/dist/*.dmg
            electron/dist/*.zip
            electron/dist/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
