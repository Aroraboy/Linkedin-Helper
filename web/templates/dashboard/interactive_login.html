{% extends "base.html" %} {% block title %}LinkedIn Login — Interactive
Browser{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">
    <i class="bi bi-window me-2"></i>LinkedIn Login — Interactive Browser
  </h4>
  <a
    href="{{ url_for('dashboard.settings') }}"
    class="btn btn-outline-secondary btn-sm"
  >
    <i class="bi bi-arrow-left me-1"></i>Back to Settings
  </a>
</div>

<div class="card">
  <div class="card-body p-3">
    <!-- Status bar -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <span id="statusBadge" class="badge bg-secondary">Not Started</span>
        <small id="currentUrl" class="text-muted ms-2"></small>
      </div>
      <div class="btn-group btn-group-sm">
        <button id="startBtn" class="btn btn-success" onclick="startSession()">
          <i class="bi bi-play-fill me-1"></i>Open LinkedIn
        </button>
        <button
          id="saveBtn"
          class="btn btn-primary d-none"
          onclick="saveSession()"
        >
          <i class="bi bi-check-circle me-1"></i>Save Session
        </button>
        <button
          id="closeBtn"
          class="btn btn-outline-danger d-none"
          onclick="closeSession()"
        >
          <i class="bi bi-x-circle me-1"></i>Close
        </button>
      </div>
    </div>

    <!-- Browser viewport -->
    <div
      id="browserContainer"
      class="position-relative mx-auto"
      style="
        width: 1280px;
        max-width: 100%;
        aspect-ratio: 1280/800;
        background: #1a1a2e;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
      "
    >
      <!-- Placeholder -->
      <div
        id="placeholder"
        class="d-flex flex-column justify-content-center align-items-center h-100 text-center p-4"
      >
        <i class="bi bi-linkedin" style="font-size: 4rem; color: #0a66c2"></i>
        <h5 class="text-light mt-3">Interactive LinkedIn Login</h5>
        <p class="text-muted">
          Click <strong>"Open LinkedIn"</strong> to launch a browser session.<br />
          You'll see LinkedIn's login page and can type your credentials<br />
          and handle any verification challenges directly.
        </p>
      </div>

      <!-- Screenshot canvas -->
      <canvas
        id="browserCanvas"
        class="d-none"
        width="1280"
        height="800"
        style="width: 100%; height: 100%"
      ></canvas>

      <!-- Loading overlay -->
      <div
        id="loadingOverlay"
        class="position-absolute top-0 start-0 w-100 h-100 d-none"
        style="background: rgba(0, 0, 0, 0.7); z-index: 10"
      >
        <div
          class="d-flex flex-column justify-content-center align-items-center h-100"
        >
          <div
            class="spinner-border text-primary"
            role="status"
            style="width: 3rem; height: 3rem"
          ></div>
          <p class="text-light mt-3">Starting browser...</p>
        </div>
      </div>
    </div>

    <!-- Instructions -->
    <div class="mt-3">
      <div class="alert alert-info py-2 mb-0" style="font-size: 0.85rem">
        <i class="bi bi-info-circle me-1"></i>
        <strong>How it works:</strong>
        Click on the browser view to interact. Type your email, password, and
        handle any CAPTCHAs or verification prompts. Once you see the LinkedIn
        feed, click <strong>"Save Session"</strong> to store your login.
        <br />
        <strong>Keyboard shortcuts:</strong>
        <kbd>Enter</kbd> to submit, <kbd>Tab</kbd> to switch fields,
        <kbd>Backspace</kbd> to delete.
      </div>
    </div>
  </div>
</div>

<script>
  const canvas = document.getElementById("browserCanvas");
  const ctx = canvas.getContext("2d");
  const placeholder = document.getElementById("placeholder");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const startBtn = document.getElementById("startBtn");
  const saveBtn = document.getElementById("saveBtn");
  const closeBtn = document.getElementById("closeBtn");
  const statusBadge = document.getElementById("statusBadge");
  const currentUrl = document.getElementById("currentUrl");

  let isActive = false;
  let pollInterval = null;

  // Scale coordinates from displayed size to actual 1280x800
  function getScaledCoords(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = 1280 / rect.width;
    const scaleY = 800 / rect.height;
    return {
      x: Math.round((e.clientX - rect.left) * scaleX),
      y: Math.round((e.clientY - rect.top) * scaleY),
    };
  }

  // Start browser session
  async function startSession() {
    startBtn.disabled = true;
    startBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
    loadingOverlay.classList.remove("d-none");
    placeholder.classList.add("d-none");

    try {
      const resp = await fetch(
        '{{ url_for("dashboard.interactive_login_start") }}',
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        },
      );
      const data = await resp.json();

      if (data.status === "ok") {
        isActive = true;
        canvas.classList.remove("d-none");
        loadingOverlay.classList.add("d-none");
        startBtn.classList.add("d-none");
        closeBtn.classList.remove("d-none");
        statusBadge.textContent = "Active";
        statusBadge.className = "badge bg-success";

        // Start polling screenshots
        pollInterval = setInterval(pollScreenshot, 500);
        // Focus the canvas area for keyboard input
        canvas.focus();
      } else {
        alert("Failed to start: " + (data.error || "Unknown error"));
        loadingOverlay.classList.add("d-none");
        placeholder.classList.remove("d-none");
        startBtn.disabled = false;
        startBtn.innerHTML =
          '<i class="bi bi-play-fill me-1"></i>Open LinkedIn';
      }
    } catch (err) {
      alert("Error: " + err.message);
      loadingOverlay.classList.add("d-none");
      placeholder.classList.remove("d-none");
      startBtn.disabled = false;
      startBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Open LinkedIn';
    }
  }

  // Poll for screenshots
  async function pollScreenshot() {
    if (!isActive) return;

    try {
      const resp = await fetch(
        '{{ url_for("dashboard.interactive_login_screenshot") }}',
      );
      const data = await resp.json();

      if (data.status === "ok" && data.screenshot) {
        // Draw screenshot to canvas
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = "data:image/jpeg;base64," + data.screenshot;

        // Update URL display
        if (data.url) {
          const short =
            data.url.length > 60 ? data.url.substring(0, 60) + "..." : data.url;
          currentUrl.textContent = short;
        }

        // Show save button if logged in
        if (data.logged_in) {
          saveBtn.classList.remove("d-none");
          statusBadge.textContent = "Logged In!";
          statusBadge.className = "badge bg-primary";
        }
      } else if (data.status === "inactive") {
        stopPolling();
      }
    } catch (err) {
      // Ignore polling errors
    }
  }

  // Canvas click → forward to browser
  canvas.addEventListener("click", async (e) => {
    if (!isActive) return;
    const coords = getScaledCoords(e);

    try {
      await fetch('{{ url_for("dashboard.interactive_login_click") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ x: coords.x, y: coords.y }),
      });
    } catch (err) {}

    // Refresh screenshot after click
    setTimeout(pollScreenshot, 300);
  });

  // Keyboard input → forward to browser
  document.addEventListener("keydown", (e) => {
    if (!isActive) return;

    // Prevent default for special keys
    const specialKeys = [
      "Enter",
      "Tab",
      "Backspace",
      "Delete",
      "ArrowLeft",
      "ArrowRight",
      "ArrowUp",
      "ArrowDown",
      "Escape",
    ];

    if (specialKeys.includes(e.key)) {
      e.preventDefault();
      fetch('{{ url_for("dashboard.interactive_login_type") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: e.key }),
      });
      setTimeout(pollScreenshot, 200);
    } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      e.preventDefault();
      fetch('{{ url_for("dashboard.interactive_login_type") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: e.key }),
      });
      setTimeout(pollScreenshot, 100);
    }
  });

  // Save session
  async function saveSession() {
    saveBtn.disabled = true;
    saveBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

    try {
      const resp = await fetch(
        '{{ url_for("dashboard.interactive_login_save") }}',
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        },
      );
      const data = await resp.json();

      if (data.status === "ok") {
        stopPolling();
        statusBadge.textContent = "Session Saved!";
        statusBadge.className = "badge bg-success";
        alert(
          "LinkedIn session saved successfully! Redirecting to settings...",
        );
        window.location.href = '{{ url_for("dashboard.settings") }}';
      } else {
        alert("Error: " + (data.error || "Failed to save session"));
        saveBtn.disabled = false;
        saveBtn.innerHTML =
          '<i class="bi bi-check-circle me-1"></i>Save Session';
      }
    } catch (err) {
      alert("Error: " + err.message);
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Session';
    }
  }

  // Close session
  async function closeSession() {
    try {
      await fetch('{{ url_for("dashboard.interactive_login_close") }}', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
    } catch (err) {}

    stopPolling();
    window.location.href = '{{ url_for("dashboard.settings") }}';
  }

  function stopPolling() {
    isActive = false;
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  // Clean up on page leave
  window.addEventListener("beforeunload", () => {
    if (isActive) {
      navigator.sendBeacon(
        '{{ url_for("dashboard.interactive_login_close") }}',
      );
    }
  });
</script>
{% endblock %}
